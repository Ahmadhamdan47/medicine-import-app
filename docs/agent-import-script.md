# Agent Import Script Documentation

## Overview

The `create-agents-from-csv.js` script automates the process of importing pharmaceutical agents from a CSV file and creating corresponding user accounts for testing purposes.

## What It Does

1. **Reads Agent Data**: Parses the `agent.csv` file containing pharmaceutical agent names
2. **Creates Agent Records**: Inserts agent information into the `agent` table
3. **Creates User Accounts**: Generates user accounts for each agent with login credentials
4. **Sets Default Passwords**: Assigns a standard password (`agent123`) for testing purposes

## File Location

- **Script**: `scripts/create-agents-from-csv.js`
- **Data Source**: `src/data/agent.csv`

## Usage

### Basic Usage

```bash
# Run the script
node scripts/create-agents-from-csv.js
```

### Prerequisites

Before running the script, ensure:

1. **Database is running** and accessible
2. **Agent role exists** in the roles table (script will create if missing)
3. **CSV file exists** at `src/data/agent.csv`
4. **Dependencies installed**: `npm install`

## CSV File Format

The script expects a simple CSV format:

```csv
Agent
Droguerie Columbus
Pharmaline S.A.L.
Mediterranean Pharmaceutical Company
Sadco
Mephico S.A.L.
...
```

- First line is treated as header (optional)
- Each subsequent line contains one agent name
- Empty lines are ignored

## Generated Data

### Agent Records

For each agent, the script creates a record in the `agent` table with:

| Field | Value | Description |
|-------|-------|-------------|
| `AgentName` | From CSV | Original agent name |
| `AgentType` | "Distributor" | Default type |
| `IsSupplier` | `true` | Marked as supplier |
| `IsManufacturer` | `false` | Not a manufacturer |
| `IsActive` | `true` | Active status |
| `CreatedDate` | Current timestamp | Creation date |
| `UpdatedDate` | Current timestamp | Last update date |
| `esignature` | Empty string | Electronic signature field |

### User Accounts

For each agent, creates a user account with:

| Field | Value | Description |
|-------|-------|-------------|
| `Username` | Generated | Cleaned agent name + index |
| `Email` | Generated | Based on agent name + index |
| `PasswordHash` | Hashed "agent123" | BCrypt hashed password |
| `RoleId` | Agent role ID | References the Agent role |
| `AgentId` | Agent record ID | Links to created agent |
| `IsActive` | `true` | Active status |

### Username Generation

Usernames are generated by:
1. Converting agent name to lowercase
2. Removing special characters
3. Replacing spaces with underscores
4. Limiting to 20 characters
5. Adding a 3-digit index (001, 002, etc.)

**Examples:**
- "Droguerie Columbus" â†’ `droguerie_columbus_001`
- "Pharmaline S.A.L." â†’ `pharmaline_sal_002`
- "Mediterranean Pharmaceutical Company" â†’ `mediterranean_pharm_003`

### Email Generation

Emails follow the pattern: `{clean_name}.{index}@agent-test.com`

**Examples:**
- "Droguerie Columbus" â†’ `droguerie.columbus.001@agent-test.com`
- "Pharmaline S.A.L." â†’ `pharmaline.sal.002@agent-test.com`

## Default Credentials

All created user accounts have:
- **Password**: `agent123`
- **Role**: Agent
- **Status**: Active

## Script Output

The script provides detailed console output:

```
ðŸš€ Starting Agent Import Process...

ðŸ”Œ Connecting to database...
âœ… Database connection established

ðŸ“„ Found 119 agent names in CSV file
âœ… Agent role found

ðŸš€ Starting agent and account creation...

ðŸ“ Processing: Droguerie Columbus
   ðŸ“‹ Created agent record (ID: 1)
   ðŸ‘¤ Created user account (ID: 123)
   ðŸ”‘ Username: droguerie_columbus_001
   ðŸ“§ Email: droguerie.columbus.001@agent-test.com
   âœ… Success!

[... continues for each agent ...]

============================================================
ðŸ“Š AGENT IMPORT SUMMARY
============================================================
âœ… Successfully created: 115
âš ï¸  Skipped: 4
âŒ Errors: 0

ðŸ“‹ SUCCESSFULLY CREATED:
----------------------------------------
1. Droguerie Columbus
   Username: droguerie_columbus_001
   Email: droguerie.columbus.001@agent-test.com
   Agent ID: 1, User ID: 123

[... full list ...]

ðŸ”‘ DEFAULT PASSWORD FOR ALL ACCOUNTS: agent123

âš ï¸  SECURITY NOTE: These accounts are for testing purposes only!
   Change passwords before production deployment.

âœ¨ Agent import process completed!
============================================================
```

## Error Handling

The script handles various scenarios:

1. **Duplicate Agents**: Skips agents that already exist in the database
2. **Username Conflicts**: Skips if generated username already exists
3. **Database Errors**: Reports connection or query issues
4. **File Errors**: Handles missing or unreadable CSV files
5. **Role Missing**: Creates the Agent role if it doesn't exist

## Security Considerations

âš ï¸ **Important Security Notes:**

1. **Testing Only**: These accounts are designed for development/testing
2. **Default Password**: All accounts use the same weak password
3. **Production Safety**: Delete or disable these accounts before production
4. **Email Domain**: Uses `@agent-test.com` to avoid real email conflicts
5. **Password Policy**: Consider implementing stronger password requirements

## Database Tables Affected

### Primary Tables
- `agent` - Agent company information
- `useraccounts` - User login credentials and profile
- `roles` - User roles (ensures Agent role exists)

### Relationships
- `useraccounts.RoleId` â†’ `roles.RoleId`
- `useraccounts.AgentId` â†’ `agent.AgentID`

## Customization

### Modifying Default Password

Change the `DEFAULT_PASSWORD` constant:

```javascript
const DEFAULT_PASSWORD = 'your-secure-password';
```

### Changing Agent Type

Modify the agent creation section:

```javascript
const agentRecord = await Agent.create({
    AgentName: agentName,
    AgentType: 'Your-Type', // Change this
    // ... other fields
});
```

### Custom Username Format

Modify the `generateUsername` function:

```javascript
function generateUsername(agentName, index) {
    // Your custom logic here
    return customUsername;
}
```

## Testing and Verification

After running the script:

1. **Check Database**: Verify records in `agent` and `useraccounts` tables
2. **Test Login**: Try logging in with generated credentials
3. **API Testing**: Use accounts for API endpoint testing
4. **Role Verification**: Confirm users have Agent role permissions

### Sample Login Test

```javascript
// Test login with generated credentials
const loginData = {
    username: 'droguerie_columbus_001',
    password: 'agent123'
};

// POST to /auth/login or your login endpoint
```

## Maintenance

### Re-running the Script

The script is idempotent and can be safely re-run:
- Existing agents/users are skipped
- New entries from updated CSV are processed
- No duplicate records are created

### Updating Agent Information

To update existing agents:
1. Modify agent records directly in database, or
2. Create a separate update script based on this template

### Cleaning Up Test Data

To remove test accounts:

```sql
-- Remove user accounts (adjust email pattern as needed)
DELETE FROM useraccounts WHERE Email LIKE '%@agent-test.com';

-- Remove agent records (if needed)
DELETE FROM agent WHERE CreatedDate > 'YYYY-MM-DD' AND AgentType = 'Distributor';
```

## Troubleshooting

### Common Issues

1. **Database Connection Failed**
   - Check database configuration in `config/databasePharmacy.js`
   - Ensure database server is running

2. **CSV File Not Found**
   - Verify file exists at `src/data/agent.csv`
   - Check file permissions

3. **Role Not Found**
   - Script creates Agent role automatically
   - Check roles table for existing roles

4. **Username Conflicts**
   - Script skips duplicate usernames
   - Check existing useraccounts table

5. **Permission Errors**
   - Ensure database user has INSERT permissions
   - Check table constraints and foreign keys

### Debug Mode

For additional debugging, modify the script to log more details:

```javascript
// Add to main function
console.log('Debug: Agent record:', agentRecord);
console.log('Debug: User account:', userAccount);
```

## Integration with Existing Systems

### API Endpoints

Created agents can immediately use:
- Authentication endpoints (`/auth/login`)
- Agent-specific importation endpoints
- Profile management endpoints

### Workflow Integration

Agents are ready for:
- Creating importation requests
- Uploading proforma invoices
- Managing their agent profile
- Participating in approval workflows

## Future Enhancements

Potential improvements:
1. **CSV Validation**: Enhanced format checking
2. **Batch Processing**: Handle very large CSV files
3. **Configuration File**: External config for passwords/settings
4. **Audit Logging**: Track all creation activities
5. **Email Verification**: Send welcome emails to generated addresses
6. **Password Complexity**: Generate secure random passwords
7. **Role Assignment**: Support multiple roles from CSV

---

## Quick Reference

| Action | Command |
|--------|---------|
| Run Script | `node scripts/create-agents-from-csv.js` |
| Default Password | `agent123` |
| Email Pattern | `{name}.{index}@agent-test.com` |
| Username Pattern | `{name}_{index}` |
| CSV Location | `src/data/agent.csv` |

---

*Last Updated: June 25, 2025*  
*Script Version: 1.0.0*
